rules_version = '2';

// ===========================================
// üîê FIRESTORE SECURITY RULES - KID TO KID
// ===========================================
// √öltima atualiza√ß√£o: Janeiro 2026
// Documenta√ß√£o: https://firebase.google.com/docs/firestore/security/get-started

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // ‚öôÔ∏è SETTINGS (Modo desenvolvimento)
    // ========================================
    match /settings/{document=**} {
      allow read: if true;
      allow write: if true;  // TEMPOR√ÅRIO: Alterar para isAdmin() em produ√ß√£o
    }
    
    // ========================================
    // üìã FUN√á√ïES AUXILIARES
    // ========================================
    
    // Verificar se utilizador est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar se √© o pr√≥prio utilizador
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Verificar se √© admin (baseado em custom claims)
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.admin == true;
    }
    
    // Verificar se √© staff (admin ou moderador)
    function isStaff() {
      return request.auth != null && 
             (request.auth.token.admin == true || 
              request.auth.token.moderator == true);
    }
    
    // Validar campos obrigat√≥rios de produto
    function hasValidProductFields() {
      let required = ['title', 'price', 'category', 'condition'];
      return request.resource.data.keys().hasAll(required);
    }
    
    // Validar pre√ßo positivo
    function hasValidPrice() {
      return request.resource.data.price > 0;
    }
    
    // Verificar tamanho m√°ximo de string
    function isValidString(field, maxLength) {
      return request.resource.data[field] is string &&
             request.resource.data[field].size() <= maxLength;
    }
    
    // ========================================
    // üõçÔ∏è PRODUTOS
    // ========================================
    match /products/{productId} {
      // Leitura p√∫blica - qualquer pessoa pode ver produtos
      allow read: if true;
      
      // DESENVOLVIMENTO: Permitir escrita para seed
      // PRODU√á√ÉO: Descomentar linha abaixo e comentar as 3 seguintes
      // allow create, update: if isStaff() && hasValidProductFields() && hasValidPrice();
      allow create: if true;
      allow update: if true;
      allow delete: if true;
    }
    
    // ========================================
    // üìÇ CATEGORIAS
    // ========================================
    match /categories/{categoryId} {
      // Leitura p√∫blica
      allow read: if true;
      
      // DESENVOLVIMENTO: Permitir escrita para seed
      allow create: if true;
      allow update: if true;
      allow delete: if true;
    }
    
    // ========================================
    // üë§ UTILIZADORES
    // ========================================
    match /users/{userId} {
      // Ler pr√≥prio perfil ou admin pode ver todos
      allow read: if isOwner(userId) || isAdmin();
      
      // Criar pr√≥prio perfil ao registar
      allow create: if isOwner(userId);
      
      // Atualizar pr√≥prio perfil
      allow update: if isOwner(userId);
      
      // Eliminar - n√£o permitido (soft delete)
      allow delete: if false;
      
      // Sub-cole√ß√£o: endere√ßos do utilizador
      match /addresses/{addressId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ========================================
    // üõí ENCOMENDAS
    // ========================================
    match /orders/{orderId} {
      // Ler pr√≥prias encomendas ou staff v√™ todas
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isStaff());
      
      // Criar encomenda - utilizador autenticado
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Atualizar - staff ou pr√≥prio utilizador (cancelar)
      allow update: if isAuthenticated();
      
      // Eliminar - nunca (manter hist√≥rico)
      allow delete: if false;
    }
    
    // ========================================
    // ‚ù§Ô∏è FAVORITOS
    // ========================================
    match /favorites/{favoriteId} {
      // Ler pr√≥prios favoritos
      allow read: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
      
      // Adicionar favorito
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Remover favorito
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      allow update: if false;
    }
    
    // ========================================
    // üõí CARRINHO
    // ========================================
    match /carts/{userId} {
      allow read, write: if isOwner(userId);
      
      match /items/{itemId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ========================================
    // üìä ANALYTICS
    // ========================================
    match /analytics/{docId} {
      allow read: if isStaff();
      allow write: if false;
    }
    
    // ========================================
    // üìß NEWSLETTER
    // ========================================
    match /newsletter/{emailId} {
      allow create: if request.resource.data.email is string;
      allow read, delete: if isAdmin();
      allow update: if false;
    }
    
    // ========================================
    // üí¨ CONTACTOS
    // ========================================
    match /contacts/{contactId} {
      allow create: if request.resource.data.email is string &&
                       request.resource.data.message is string;
      allow read, update: if isStaff();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üè∑Ô∏è CUP√ïES
    // ========================================
    match /coupons/{couponId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // üîß CONFIGURA√á√ïES
    // ========================================
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ========================================
    // üìù LOGS
    // ========================================
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }
  }
}
